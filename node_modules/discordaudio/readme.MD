# Discord Audio
<img src="https://www.extive.eu/assets/img/discordaudio.png" height="200" width="200">

## What is Discord Audio?
Discord Audio is a package based on Discord.js to play songs in your voice channel. This can be a YouTube song or just a stream. It is very easy to use and works on Discord.js v12+ versions.

## How do I install Discord Audio
Use the NPM command `npm install discordaudio`

Or use the yarn command `yarn add discordaudio`

## How does Discord Audio works
The Discord Audio package provides 4 classes.
- Player
- Connection
- Broadcast
- Adapter

## Which class do I need to use?
In the most cases you would use the Player class. The Player class is be誰ng used for creating a music player in one server. The Player class can play YouTube urls and stream urls. The Connection and Broadcast class can only play stream urls. The connection is be誰ng used for playing a stream in one server and as early mentioned, only for stream urls. You can of course use [ytdl-core](https://npmjs.com/package/ytdl-core) to play a YouTube url. The Broadcast class creates a broadcast. This broadcast can play the same stream in multiple servers with the options. The broadcast can be played by using the Connection class. In this documentation you will find more about every little detail.

The Adapter class is instead of the other classes not made to play a stream. The Adapter class creates an Adapter for you if you want to use something else to make a stream player with. The difference between the discordaudio Adapter class and the default Discord.js adapter is that the discordaudio adapter also works for Discord.js version 12.

### Player
The player class has been made for Discord music bots. It has easy functions to use and automatically converts YouTube url's to playable streams.
#### player.play(stream, options)
The player.play(stream, options) function will make the bot play a song. The stream can be a YouTube url and a stream url.
```js
const discordaudio = require('discordaudio');
...
const channel = client.channels.cache.get('01234567890');
const player = new discordaudio.Player(channel);
player.play('https://www.youtube.com/watch?v=dQw4w9WgXcQ', {
    autoleave: true,
    quality: 'high',
    selfDeaf: true,
    selfMute: false
});
```
The play function has multiple options:
- The 'autoleave' option will make the bot automatically leave the voice channel once the song ended. By default this is set to false
- The 'quality' option will change the quality of the song (only works with YouTube urls). By default this is set to 'low'.
- The 'selfDeaf' option will set the self deaf for the bot. By default this is set to true.
- The 'selfMute' option will set the self mute for the bot. By default this is set to false.

#### player.reconnect(timeout)
The player.reconnect(timeout) function will make the bot reconnect with the voice channel.
```js
const discordaudio = require('discordaudio');
...
const player = new discordaudio.Player(channel);
...
player.reconnect(5000);
```
The reconnect timeout is in this example 5 seconds. By default this will be 2 seconds.

#### player.volume(volume)
The player.volume(volume) function changes the volume of the song.
```js
const discordaudio = require('discordaudio');
...
const player = new discordaudio.Player(channel);
...
player.volume(1); // Sets the volume to 1/10
player.volume('5/5'); // Sets the volume to 5/10
```
You can set the volume as a number or as a string. If you set the volume as a number, the max will standardly be 10.

#### player.destroy()
Destroys the player

#### player.disconnect()
Disconnects to the channel

#### player.pause()
Pauses the song

#### player.resume()
Resumes a paused song

#### player.getStatus()
Checks if the song is playable or not

#### player.getListeners()
Gets the amount of users in the voice channel

#### Player event listeners
The player provides 4 event listeners which you can use.
```js
const discordaudio = require('discordaudio');
...
const player = new discordaudio.Player(channel);
...
player.on('play', () => {
    console.log(`The song started playing`);
});
player.on('stop', () => {
    console.log(`The song ended!`);
});
player.on('disconnect', () => {
    console.log(`The bot got disconnected with the voice channel!`);
});
player.on('destroy', () => {
    console.log(`The player got destroyed`);
});
```

### Connections
Connections are be誰ng used for non-stop streams to only stream in one voice channel. If you want to stream a non-stop stream in multiple voice channels see the Broadcasts. The biggest difference between connections and players are that connections already join before the play function is be誰ng called and has more advanced options.

#### Creating a connection
You can create a connection by calling the Connection class.
```js
const discordaudio = require('discordaudio');
...
const channel = client.channels.cache.get('01234567890');
const connection = new discordaudio.Connection(channel, {
    selfDeaf: true,
    selfMute: false
});
```
The Connection class has multiple options:
- The 'selfDeaf' option sets the self deaf of the bot. By default this is true.
- The 'selfMute' options sets the self mute of the bot. By default this is false.

#### connection.play(stream, options)
You can play a stream by using the play function
```js
const discordaudio = require('discordaudio');
...
const connection = new discordaudio.Connection(channel);
connection.play('https://mycoolwebsite.com/stream', {
    noListeners: 'pause',
    volume: 1
});
```
The play fuction has multiple options:
- The 'noListeners' option sets what the bot has to do when there are no listeners anymore in the voice channel. You can set this to different options:
    - The 'pause' will pause the stream when there is no one listening
    - The 'play' will continue playing the stream when there is no one listening
    - The 'stop' will stop the stream when there is no one listening
- The 'volume' options sets the volume of the stream. By default is this 1(/1).

#### connection.volume(volume)
The connection.volume(volume) function will change the volume of the stream.
```js
const discordaudio = require('discordaudio');
...
const connection = new discordaudio.Connection(channel);
...
connection.volume(1); // Sets the volume to max
```
The max volume is 1. The difference between the Player and the Connection class for the volume is that you only can use a number for the Connection class and the max is 1 at the Connection class.

#### connection.disconnect()
Disconnects with the voice channel

#### connection.destroy()
Destroys the connection

#### connection.pause()
Pauses the stream

#### connection.resume()
Resumes the paused stream

#### connection.subscribe(broadcast)
This function only works for broadcasts. More explanation about this function is at the broadcast chapter.

#### connection.unsubscribe()
Unsubscribes to a broadcast. More explanation about this function is at the broadcast chapter.

#### Connection event listeners
The Connection class provides 6 event listeners. 2 of them are for the Broadcast so those will be shown at the Broadcasts chapter.
```js
const discordaudio = require('discordaudio');
...
const connection = new discordaudio.Connection(channel);
...
connection.on('play', () => {
    console.log(`The stream is playing`);
});
connection.on('end', () => {
    console.log(`The stream got ended`);
});
connection.on('disconnect', () => {
    console.log(`I got disconnected from the voice channel`);
});
connection.on('destroy', () => {
    console.log(`The connection got destroyed`);
});
```

### Broadcasts
The Broadcast class is here for when you want to play one stream in multiple voice channels. You can play these broadcasts 

#### Creating a broadcast
You can create a broadcast by using the Broadcast class. After creating a broadcast you can play it by using the subscribe function in the Connection class.
```js
const discordaudio = require('discordaudio');

const broadcast = new discordaudio.Broadcast('https://mycoolwebsite.com/stream', {
    noListeners: 'play',
    volume: 1
});
```
The Broadcast class also has some options:
- The 'noListeners' option sets what the bot has to do when there are no listeners anymore in the voice channel. You can set this to different options:
    - The 'pause' will pause the stream when there is no one listening
    - The 'play' will continue playing the stream when there is no one listening
    - The 'stop' will stop the stream when there is no one listening
- The 'volume' options sets the volume of the stream. By default is this 1(/1).

#### Playing the broadcast
After the broadcast has been created you can play it by using the subscribe function in the Connection class.
```js
const discordaudio = require('discordaudio');

const broadcast = new discordaudio.Broadcast('https://mycoolwebsite.com/stream', {
    noListeners: 'play',
    volume: 1
});

const channel = client.channels.cache.get('01234567890');
const connection = new discordaudio.Connection(channel);
connection.subscribe(broadcast);
```

#### Unsubscribing from a broadcast
Unsubscribing from a broadcast is really easy. You can just use the unsubscribe function from the connection.
```js
const discordaudio = require('discordaudio');

const broadcast = new discordaudio.Broadcast('https://mycoolwebsite.com/stream', {
    noListeners: 'play',
    volume: 1
});

const channel = client.channels.cache.get('01234567890');
const connection = new discordaudio.Connection(channel);
connection.subscribe(broadcast);

setTimeout(() => {
    connection.unsubscribe();
}, 5000);
```

#### Broadcast event listeners
There are 2 broadcast event listeners in the Broadcast class and 2 broadcast event listeners in the Connection class.
```js
const discordaudio = require('discordaudio');

const broadcast = new discordaudio.Broadcast('https://mycoolwebsite.com/stream', {
    noListeners: 'play',
    volume: 1
});
...
const connection = new discordaudio.Connection(channel);
connection.subscribe(broadcast);
...
broadcast.on('play', () => {
    console.log(`The stream is playing`);
});
broadcast.on('end', () => {
    console.log(`The stream got ended!`);
});
connection.on('subscribe', () => {
    console.log(`The connection got subscribed to the broadcast!`);
});
connection.on('unsubscribe', () => {
    console.log(`The connection got unsubscribed from the broadcast!`);
});
```

### Adapters
The Adapter class can be used to create an adapter if you want to use a different way to play a stream in your voice channel.

#### Creating an adapter
Creating an adapter is really easy to do. You can do it by using the Adapter class. After creating an adapter you can use it for every other way to play a stream in your voice channel.
> **Warning:** Adapters work different per voice channel. If you want to play a stream in a different voice channel, you'll need to create a new adapter.

```js
const discordaudio = require('discordaudio');
...
const channel = client.channels.cache.get(`01234567890`);
const adapter = new discordaudio.Adapter(channel);
```

#### Using an adapter
After creating an adapter you can use them to play a stream. In this example we are going to be using the [@discordjs/voice](https://npmjs.com/package/@discordjs/voice) package.
```js
const discordaudio = require('discordaudio');
const voice = require('@discordjs/voice');
...
const channel = client.channels.cache.get(`01234567890`);

const audioplayer = voice.createAudioPlayer();
const resource = voice.createAudioResource(`https://somecoolsite.com/somereallycoolstream.mp3`, {
    inputType: voice.StreamType.Arbitrary,
    inlineVolume: true
});
audioplayer.play(resource);
voice.entersState(audioplayer, voice.AudioPlayerStatus.Playing, 5e3);

const connection = voice.joinVoiceChannel({
    channelId: channel.id,
    guildId: channel.guild.id,
    adapterCreator: new discordaudio.Adapter(channel),
    selfDeaf: true,
    selfMute: false
});

try{
    await voice.entersState(connection, voice.VoiceConnectionStatus.Ready, 30e3);
} catch(error) {
    connection.destroy();
    console.error(error);
}

connection.subscribe(audioplayer);
```

### Example for Discord.js music bot v13 (Other examples can be found in the examples folder in the package, also for other versions)
```javascript
const discordaudio = require('discordaudio');
const Discord = require('discord.js');

const config = {
    prefix: '!',
    token: 'Your-Secret-Token'
};

const client = new Discord.Client({intents: [Discord.Intents.FLAGS.GUILDS, Discord.Intents.FLAGS.GUILD_VOICE_STATES, Discord.Intents.FLAGS.GUILD_MESSAGES]});

const audioplayers = new Map();

client.once('ready', () => console.log(`Started!`));

client.on('message', async message => {
    if(message.author.bot || message.channel.type === `dm`) return;

    if(!message.content.startsWith(config.prefix)) return;
    let args = message.content.substring(config.prefix.length).split(" ");

    switch(args[0].toLowerCase()){
        case 'play':
            if(!args[1]) return message.channel.send({content: `Please specify a stream URL`});
            if(!args[1].startsWith("https://") && !args[1].startsWith("http://")) return message.channel.send({content: `Wait a minute! That's not a URL!`});
            if(!message.member.voice.channel) return message.channel.send({content: `You need to join a voice channel before you can play something`});
            if(audioplayers.get(message.guild.id)) audioplayers.get(message.guild.id).destroy();
            const player = new discordaudio.Player(message.member.voice.channel);
            player.play(args[1], {
                quality: 'high',
                autoleave: true
            }).catch(err => {
                message.channel.send({content: `There was an error while trying to play your cool song!`});
                console.log(err);
            });
            player.on('play', () => {
                audioplayers.set(message.guild.id, player);
                message.channel.send({content: `I'm playing your cool song!`});
            });
            player.on('stop', () => {
                audioplayers.delete(message.guild.id, player);
                message.channel.send({content: `Your song is done!`});
            });
            break;
        case 'destroy':
            if(!message.member.voice.channel) return message.channel.send({content: `You need to join a voice channel before you can destroy the player`});
            if(audioplayers.get(message.guild.id)){
                audioplayers.get(message.guild.id).destroy();
                audioplayers.delete(message.guild.id);
            }
            break;
        case 'disconnect':
            if(!message.member.voice.channel) return message.channel.send({content: `You need to join a voice channel before you can disconnect the player`});
            if(audioplayers.get(message.guild.id)){
                audioplayers.get(message.guild.id).disconnect();
                audioplayers.delete(message.guild.id);
            }
            break;
        case 'reconnect':
            if(!message.member.voice.channel) return message.channel.send({content: `You need to join a voice channel before you can reconnect the player`});
            if(audioplayers.get(message.guild.id)) await audioplayers.get(message.guild.id).reconnect(5000);
            break;
        case 'pause':
            if(!message.member.voice.channel) return message.channel.send({content: `You need to join a voice channel before you can pause the player`});
            if(audioplayers.get(message.guild.id)) audioplayers.get(message.guild.id).pause();
            break;
        case 'resume':
            if(!message.member.voice.channel) return message.channel.send({content: `You need to join a voice channel before you can resume the player`});
            if(audioplayers.get(message.guild.id)) audioplayers.get(message.guild.id).resume();
            break;
        case 'volume':
            if(!message.member.voice.channel) return message.channel.send({content: `You have to be in a voice channel to change the volume of a song`});
            if(audioplayers.get(message.guild.id)){
                if(!args[1]) return message.channel.send({content: `Please provide the volume in the second argument of the command`});
                if(!isNaN(Number(args[1]))){
                    if(Number(args[1]) > 10 || Number(args[1]) < 1) message.channel.send({content: `The volume must be between the number 1-10`});
                    else {
                        audioplayers.get(message.guild.id).player.volume(Number(args[1]));
                        message.channel.send({content: `The volume has been changed`});
                    }
                } else if(!args[1].includes("/")) return message.channel.send({content: `Invalid volume`});
                else {
                    let volume = args[1].split("/");
                    if(isNaN(Number(volume[0])) || isNaN(Number(args[1]))) return message.channel.send({content: `Invalid volume`});
                    if(Number(volume[0]) > Number(volume[1])) return message.channel.send({content: `Invalid volume`});
                    audioplayers.get(message.guild.id).player.volume(`${volume[0]}/${volume[1]}`);
                    message.channel.send({content: `The volume has been changed`});
                }
            }
            break;
        case 'isplayable':
            if(!message.member.voice.channel) return message.channel.send({content: `You need to join a voice channel before you can see if the song is playable`});
            if(audioplayers.get(message.guild.id)){
                const playing = await audioplayers.get(message.guild.id).getStatus() === true ? 'The song is playable!' : 'The song is **not** playable!';
                message.channel.send({content: playing});
            }
            break;
        case 'listeners':
            if(audioplayers.get(message.guild.id)) message.channel.send({content: `There are **${String(await audioplayers.get(message.guild.id).getListeners())}** listening in the voice channel!`});
            break;
    }
});

client.login(config.token);
```

### Credits:
Written by the [Extive](https://www.extive.eu/discord) developers

Management by Luuk